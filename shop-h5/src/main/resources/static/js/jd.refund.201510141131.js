define('jd.refund',function(require,exports,module){var url=require("url"),ls=require('loadJs'),util=require('util'),ui=require('ui'),fj=require('formatJson'),cookies=require('cookie'),md5=require('md5'),login=require('login'),$=require('zepto'),isoldpin=util.getQuery("isoldpin"),tempOldpin=(isoldpin&&(isoldpin=="1"||isoldpin==1))?"&isoldpin=1":"",curl=encodeURIComponent(location.href);function initItemRefundDetail(){var serviceId=url.getUrlParam("afsserviceid");if(!serviceId){alert("页面参数有误！");}
if(pageData&&pageData.sendPay&&pageData.sendPay.length>10&&pageData.sendPay.charAt(9)=='4'){$('#chouTopTip').show();}
if(pageData.financeList.length){$("#refundFinance").show();}
if(pageData.allowOperations.length){if(pageData.allowOperations.indexOf(2)>-1&&!pageData.serviceExpressInfoDTO.expressCompany){$("#sendBack").show().on("click",function(){location.href="http://wqs.jd.com/refund/item_sendback.shtml?afsserviceid="+serviceId+tempOldpin;});}
if(pageData.allowOperations.indexOf(1)>-1){$("#btnCancel").show().on("click",function(e){e.preventDefault();if(confirm("你确定要取消吗？")){location.href=ls.addToken("http://wq.jd.com/jdmrefund/cancelservice?afsserviceid="+serviceId+tempOldpin+"&t="+Math.random(),'lk');}});}}
if(pageData.questionPic){$("#picTitle").show().after(fj.formatJson("picTpl",{list:pageData.questionPic.split(",")}));$(".mod_uploadImg img").on("click",function(){$("#picPreview img").attr("src",this.src);$("#picPreview").show();});$("#picPreview").on("click",function(){$(this).hide();});}}
function initApplyItemRefund(){var orderId=url.getUrlParam("orderid"),skuid=url.getUrlParam("skuid"),cetype=url.getUrlParam("cetype"),isRefund=cetype==10,jdpin=url.getUrlParam("jdpin"),maxNum=pageData.item.maxNum*1,maxFileSize=3;if(!orderId||!skuid){alert("参数有误！");$("#applyRefund").hide();return;}
if(pageData&&pageData.sendPay&&pageData.sendPay.length>10&&pageData.sendPay.charAt(9)=='4'){$('#chouTopTip').show();}
if(cetype==10){$("#curTitle").html("申请退货");document.title="申请退货";}else if(cetype==20){$("#curTitle").html("申请换货");document.title="申请换货";}else{$("#curTitle").html("申请维修");document.title="申请维修";}
if(maxNum<=1){$("#modifyNum").hide();}
if(isRefund){$("#recvDiv").hide();bindRebackEvent();}else{$("#rebackDiv").hide();jdDistrict({ids:['recvProvince','recvCity','recvCounty','recvTown'],code:[pageData.address.provinceId,pageData.address.cityId,pageData.address.countyId,pageData.address.townId],onInit:function(selAddr){if(selAddr.provinceId<5){$("#recvTown").hide();}
$('#recvAddrInfo').val(selAddr.provinceId+","+selAddr.cityId+","+selAddr.countyId+","+selAddr.townId+","+selAddr.provinceName+","+selAddr.cityName+","+selAddr.countyName+","+selAddr.townName);},onChange:function(selAddr){selAddr.provinceId<5?$("#recvTown").hide():$("recvTowntown").show();$('#recvAddrInfo').val(selAddr.provinceId+","+selAddr.cityId+","+selAddr.countyId+","+selAddr.townId+","+selAddr.provinceName+","+selAddr.cityName+","+selAddr.countyName+","+selAddr.townName);}});$("#recvAddrDetail").val(pageData.address.addrDetail);}
if(pageData.item.maxNum<=1){$("#modifyNum").hide();}
$("#modifyNum").on("tap",function(){$("#refundInfoEdit").show();$("#refundInfo").hide();});$("#minusNum").on("tap",function(){var curNum=$("#curNum").val()*1;if(curNum<=1){return;}
$("#curNum").val(curNum-1);});$("#addNum").on("tap",function(){var curNum=$("#curNum").val()*1;if(curNum>=maxNum){return;}
$("#curNum").val(curNum+1);});$("#curNum").on("keyup",function(){if(isNaN(this.value)){alert("请输入整数!");return;}
if(this.value>maxNum){alert("最多可申请"+maxNum+"件!");this.value=maxNum;return;}});$("#confirmNum").on("tap",function(){var curNum=$("#curNum").val();if(isNaN(curNum)){alert("必须是数字！");return;}
if(curNum>maxNum){alert("最多可申请"+maxNum+"件！");return;}
$("#refundNum").html($("#curNum").val()+"件");$("#refundInfo").show();$("#refundInfoEdit").hide();});$("#refundReason").on("keyup",function(){$("#wordLen").html($("#refundReason").val().length+"/125");});$("#pickType li").on("tap",function(){$("#pickType li").removeClass('selected');$(this).addClass("selected");if($(this).attr("code")=="4"){jdDistrict({ids:['province','city','county','town'],code:[pageData.address.provinceId,pageData.address.cityId,pageData.address.countyId,pageData.address.townId],onInit:function(selAddr){if(selAddr.provinceId<5){$("#town").hide();}
$('#addrInfo').val(selAddr.provinceId+","+selAddr.cityId+","+selAddr.countyId+","+selAddr.townId+","+selAddr.provinceName+","+selAddr.cityName+","+selAddr.countyName+","+selAddr.townName);},onChange:function(selAddr){selAddr.provinceId<5?$("#town").hide():$("#town").show();$('#addrInfo').val(selAddr.provinceId+","+selAddr.cityId+","+selAddr.countyId+","+selAddr.townId+","+selAddr.provinceName+","+selAddr.cityName+","+selAddr.countyName+","+selAddr.townName);}});$("#addrDetail").val(pageData.address.addrDetail);$("#addrRow1").show();$("#addrRow2").show();}else{$("#addrRow1").hide();$("#addrRow2").hide();}});$("#applyRefund").on("tap",function(e){var tar=$(this),mark=tar.attr('mark');if(mark==1)return;tar.attr('mark','1');var contactName=$.trim($("#contactName").val()),contactPhone=$.trim($("#contactPhone").val()),refundReason=$.trim($("#refundReason").val());var rebackType="",bank="",bank2="",bank3="",bankInfoArea="",bankInfoName="",bankInfoCode1="",bankInfoCode2="";if(isRefund){rebackType=$("#rebackType .selected").attr("code");if(!rebackType){tar.attr('mark','0');alert("请选择你期望如何返回款项！");return false;}
if(rebackType==30){if(!$('#bankLevel1').attr("selectedIndex")){tar.attr('mark','0');alert('请选择返回银行');return false;}
bank=$('#bankLevel1').val();if(!$('#bankLevel2').attr("selectedIndex")){tar.attr('mark','0');alert('请选择返回银行所在省');return false;}
bank2=$('#bankLevel2').val();if(!$('#bankLevel3').attr("selectedIndex")){tar.attr('mark','0');alert('请选择返回银行所在市');return false;}
bank3=$('#bankLevel3').val();bankInfoArea=$.trim($('#bankInfoArea').val());if(!bankInfoArea){tar.attr('mark','0');alert('请填写开户银行支行地址');return false;}
bankInfoName=$.trim($('#bankInfoName').val());if(!bankInfoName){tar.attr('mark','0');alert('请填写开户人姓名');return false;}
bankInfoCode1=$.trim($('#bankInfoCode1').val());if(!bankInfoCode1){tar.attr('mark','0');alert('请填写开户银行账号');return false;}
if(!/\d+/.test(bankInfoCode1)){tar.attr('mark','0');alert('开户银行账号格式错误');return false;}
bankInfoCode2=$.trim($('#bankInfoCode2').val());if(!bankInfoCode2){tar.attr('mark','0');alert('请填写确认银行账号');return false;}
if(!/\d+/.test(bankInfoCode2)){tar.attr('mark','0');alert('开户银行账号格式错误');return false;}
if(bankInfoCode1!=bankInfoCode2){tar.attr('mark','0');alert('两次输入的银行账号不一致');return false;}}}
var pickType=$("#pickType .selected").attr("code"),provinceId="",cityId="",countyId="",townId="",addrDetail="";if(!pickType){tar.attr('mark','0');alert("请选择你期望如何返回商品！");return;}
if(pickType==4){var arr=$("#addrInfo").val().split(",");provinceId=arr[0];cityId=arr[1];countyId=arr[2];townId=arr[3];if(!provinceId){tar.attr('mark','0');alert("请选择上门取件的省份！");return false;}
if(!cityId){tar.attr('mark','0');alert("请选择上门取件的"+(provinceId<5?"区":"城市")+"！");return false;}
if(!countyId){tar.attr('mark','0');alert("请选择上门取件的"+(provinceId<5?"街道/乡镇":"区县")+"！");return false;}
var mark=$('#town').attr('mark');if(provinceId>=5&&!townId){if(mark=='0'){townId='0';}else{tar.attr('mark','0');alert("请选择上门取件的街道/乡镇！");return false;}}
addrDetail=$.trim($("#addrDetail").val());}
var recvProvinceId="";recvCityId="",recvCountyId="",recvTownId="",recvAddrDetail="";if(!isRefund){var arr=$("#recvAddrInfo").val().split(",");recvProvinceId=arr[0];recvCityId=arr[1];recvCountyId=arr[2];recvTownId=arr[3];if(!recvProvinceId){tar.attr('mark','0');alert("请选择收货地址的省份！");return false;}
if(!recvCityId){tar.attr('mark','0');alert("请选择收货地址的"+(recvProvinceId<5?"区":"城市")+"！");return false;}
if(!recvCountyId){tar.attr('mark','0');alert("请选择收货地址的"+(recvProvinceId<5?"街道/乡镇":"区县")+"！");return false;}
var mark=$('#recvTown').attr('mark');if(recvProvinceId>=5&&!recvTownId){if(mark=='0'){recvTownId='0';}else{tar.attr('mark','0');alert("请选择收货地址的街道/乡镇！");return false;}}
recvAddrDetail=$.trim($("#recvAddrDetail").val());}
if(!contactName){tar.attr('mark','0');alert("请填写联系人姓名！");return;}
if(!contactPhone){tar.attr('mark','0');alert("请填写手机号码！");return;}
if(!/^1[3|5|8]\d{9}$/.test(contactPhone)){tar.attr('mark','0');alert("手机号码格式不对！");return;}
if(!refundReason){tar.attr('mark','0');alert("请填写退货原因！");return;}
var url='http://wq.jd.com/jdmrefund/createselfafsapply?';url=(isoldpin&&(isoldpin=="1"||isoldpin==1))?url+"isoldpin=1&":url;param=buildParam({orderid:orderId,wareid:pageData.item.wareId,customerExpect:cetype,warename:encodeURIComponent(pageData.item.wareName),warenum:$("#curNum").val(),customercontactname:encodeURIComponent(contactName),customermobilephone:contactPhone,questiondesc:encodeURIComponent(refundReason),pickwaretype:pickType,pickwareprovince:provinceId,pickwarecity:cityId,pickwarecounty:countyId,pickwarevillage:townId,pickwareaddress:addrDetail?encodeURIComponent(addrDetail):"",returnwareProvince:recvProvinceId,returnwareCity:recvCityId,returnwareCounty:recvCountyId,returnwareVillage:recvTownId,returnwareAddress:recvAddrDetail?encodeURIComponent(recvAddrDetail):"",jdpin:jdpin,refundtype:rebackType,bankcode:bankInfoCode1,bankname:isRefund?encodeURIComponent($('#bankLevel1 option[value="'+bank+'"]').attr('val')):"",bankprovince:isRefund?encodeURIComponent($('#bankLevel2 option[value="'+bank2+'"]').attr('val')):"",bankcity:isRefund?encodeURIComponent($('#bankLevel3 option[value="'+bank3+'"]').attr('val')):"",branchbankaddress:isRefund?encodeURIComponent(bankInfoArea):"",bankaccountholder:isRefund?encodeURIComponent(bankInfoName):"",questionPic:$("#uploadImg [img]").map(function(item){return $(this).attr("img")}).get().join(","),t:Math.random()});location.href=ls.addToken(url+param,'lk');return false;});$('#bankInfoCode1,#bankInfoCode2').on("blur",function(){bankInfoCode1=$.trim($('#bankInfoCode1').val());bankInfoCode2=$.trim($('#bankInfoCode2').val());if(bankInfoCode1&&!/\d+/.test(bankInfoCode1)){alert('开户银行账号格式错误');return;}
if(bankInfoCode2&&!/\d+/.test(bankInfoCode2)){alert('你填写的确认银行账号格式错误');return;}
if(bankInfoCode1&&bankInfoCode2&&bankInfoCode1!=bankInfoCode2){alert("两次输入的银行账号不一致!");}});var isIOS9=(navigator.userAgent.toLowerCase().indexOf("os 9")>-1)?true:false,isSQ=/qq\/([\d\.]+)*/i.test(navigator.userAgent);if($.os.android||!isInputTypeFileSupported()||(isIOS9&&isSQ)){$("#uploadImg").hide().prev("div").hide();}
var isUploading=false;$("#takePicture").on("change",function(e){var files=e.target.files,len=files.length,uploaded,toUpload,num=0;if(!len){return;}
if(isUploading){alert("正在上传图片，请稍后。。。");return;}
uploaded=$("#uploadImg .item").length-1;toUpload=Math.min(3-uploaded,len);if(!toUpload){return;}
for(var i=0;i<toUpload;i++){if((files[i].type&&!/image\/.*/.test(files[i].type))||(!files[i].type&&!/\.(jpg|jpeg|gif|png)$/i.test(files[i].name||files[i].fileName))){alert(len>1?("第"+i+"个文件格式不对，请选择合法格式的图片！"):"文件格式不对，请选择合法格式的图片！");return;}
if(((files[i].size||files[i].fileSize)/(1024*1024))>maxFileSize){alert(len>1?("第"+i+"个文件文件太大，请选择小于3M的图片！"):"文件太大，请选择小于3M的图片！");return;}
uploadFile(files[i]);isUploading=true;}
$("#loading").show();function uploadFile(file){var xhr=new XMLHttpRequest(),data=new FormData();data.append("strTempFile_filename",file.name);data.append("strTempFile",file);data.append("jdpin","xu_ll");xhr.onload=function(e){var ret=JSON.parse(e.target.responseText.replace(/<!--.*-->/g,""));if(ret.retCode==13){location.href=ls.addToken(ret.loginUrl,'lk');return;}
if(ret.retCode==0){previewImg(file,ret.imgUrl);}else{alert("上传图片出错啦!"+ret.errMsg);countRequest();}};xhr.onerror=function(e){alert("上传图片出错啦！"+e.type);countRequest();};xhr.open("post",ls.addToken("http://wq.jd.com/jdmrefund/uploadimage?t="+parseInt(new Date()/1000,10),'lk'));xhr.send(data);}
function previewImg(file,img){var fileReader=new FileReader();fileReader.onload=function(event){var last=$("#uploadImg .item").last();last.before('<div class="item" img="'+img+'"><img src="'+event.target.result+'" width="88" height="88"><a href="javascript:void(0);" class="btn_del">移除</a></div>');countRequest();if($("#uploadImg .item").length>=4){last.hide();}};fileReader.readAsDataURL(file);}
function countRequest(){num++;if(num==toUpload){isUploading=false;$("#loading").hide();}}});$("#uploadImg").on("click",".btn_del",function(e){$(this).parent(".item").remove();if($("#uploadImg .item").length<4){$("#uploadImg .item").last().show();}});}
function bindRebackEvent(){$("#rebackType li").on("tap",function(){$("#rebackType li").removeClass('selected');var tar=$(this);tar.addClass("selected");if(tar.attr("code")=="30"){$('#bankInfoBlock').removeClass('hide');var url='http://wq.jd.com/jdmrefund/getcitybanklist?callback=bankInfoCb&parentid=0&level=1'+tempOldpin;ls.loadScript(url);}});$('#bankLevel1').change(function(){var tar=$(this),val=tar.val();var url='http://wq.jd.com/jdmrefund/getcitybanklist?callback=bankInfoCb&parentid='+val+'&level=2'+tempOldpin;ls.loadScript(url);});$('#bankLevel2').change(function(){var tar=$(this),val=tar.val();var url='http://wq.jd.com/jdmrefund/getcitybanklist?callback=bankInfoCb&parentid='+val+'&level=3'+tempOldpin;ls.loadScript(url);});window.bankInfoCb=function(json){if(json.retcode!=0){if(json.retcode==13){json.loginUrl&&(location.href=ls.addToken(json.loginUrl+'&rurl='+curl+tempOldpin,'lk'));}
return;}
var list=json.serviceInfoList,l1=list[0];if(!l1)return;var bl=$('#bankLevel'+l1.level);$('#bankLevel'+l1.level+' option[value]').remove()
for(var i=0,len=list.length;i<len;++i){$('<option value='+list[i].id+' val='+list[i].name+'>'+list[i].name+'</option>').appendTo(bl);}};}
function initItemSendback(){var serviceId=url.getUrlParam("afsserviceid"),jdpin=url.getUrlParam("jdpin");if(!serviceId){alert("页面参数有误！");}
$("#wuliu").on("tap","li",function(){var total=$("#wuliu li").size(),me=$(this)
index=me.index();me.addClass("selected").siblings().removeClass("selected");if(index!=total-1){$("#curWuliu").html(me.html());$("#expCom").val(me.html());}else{var otherCommName=$("#otherCompany").val();$("#curWuliu").html(otherCommName?otherCommName:"");$("#expCom").val(otherCommName?otherCommName:"");}});$("#otherCompany").on("keyup blur",function(){var otherCommName=$("#otherCompany").val();$("#curWuliu").html(otherCommName);$("#expCom").val(otherCommName);})
var now=new Date(Date.now()),year=now.getFullYear(),month=now.getMonth(),day=now.getDate();for(var i=2012;i<2017;i++){if(i==year){$("#sYear option").eq(i-2013).attr("selected","selected");};}
document.getElementById("sMonth").selectedIndex=month;buildDayPicker(year,month+1);$("#sDay option").eq(day-1).attr("selected","selected");$("#sMonth").on("change",function(){var year=$("#sYear [selected='selected']").val()*1;var month=$(this).val()*1;buildDayPicker(year,month);$("#sDay option").eq(0).attr("selected","selected");});$("#confirmIt").on("tap",function(e){e.preventDefault();var expCom=$.trim($("#expCom").val()),expCode=$.trim($("#expCode").val()),freightFee=$.trim($("#freightFee").val()),deliverdate=new Date($("#sYear").val()*1,$("#sMonth").val()-1,$("#sDay").val()*1);if(!serviceId){alert("页面参数有误，无法提交！");return;}
if(!expCom){alert("请选择或者填写物流公司！");return;}
if(!expCode){alert("请填写发货单号！");return;}
if(!freightFee){alert("请填写运费！");return;}
if(freightFee>10000){alert("运费金额过大！");return;}
if(isNaN(freightFee)){alert("运费必须是数字！");return;}
if(deliverdate>new Date()){alert("发货日期必须是今天之前的日期！");return;}
location.href=ls.addToken("http://wq.jd.com/jdmrefund/saveafssendwareinfo?afsserviceid="+serviceId+"&expresscompany="+encodeURIComponent(expCom)+"&expresscode="+expCode+"&freightmoney="+freightFee+"&deliverdate="+parseInt(deliverdate.getTime()/1000)+"&jdpin="+jdpin+tempOldpin+"&t="+Math.random(),'lk');});function buildDayPicker(year,month){var maxDay=[1,3,5,7,8,10,12].indexOf(month*1)>-1?31:month!=2?30:((year%4==0&&year0!=0)||year%400==0)?29:28;var html=[];for(var i=1;i<=maxDay;i++){html.push("<option value='"+i+"'>"+i+"</option>");}
$("#sDay").html(html.join(""));}}
function initItemRefundList(){var orderid=url.getUrlParam("orderid"),pagesize=url.getUrlParam("pagesize")*1,pageindex=url.getUrlParam("pageindex")*1,refreshBarHeight=$("#refreshBar").offset().top,$win=$(window),isLoadData=false,stateMap={10:"已提交申请，待审核",20:"审核不通过",21:"待客服审核",22:"待商家审核",31:"待京东收货",20:"待商家收货",33:"京东售后处理中",34:"商家售后处理中",40:"待用户确认",50:"完成",60:"取消"};if(!orderid||!pagesize||!pageindex){alert("页面参数有误！");return;}
if(pageindex*pagesize>=pageData.totalNum){$("#refreshBar").hide();return;}
$win.on("scroll",function(){if(pageindex*pagesize>=pageData.totalNum){$("#refreshBar").hide();$win.off("scroll");return;}
if($win.height()+$win.scrollTop()>=refreshBarHeight){!isLoadData&&loadServieList();}});function loadServieList(){window.getServiceList=function(json){if(json.retcode!=0){if(json.retcode==13){json.loginUrl&&(location.href=ls.addToken(json.loginUrl+'&rurl='+curl,'lk'));}
return;}
json.serviceInfoList.forEach(function(item){item.stepName=stateMap[item.afsServiceStep]||"";});$("#serviceList").append(fj.formatJson("serviceTpl",json.serviceInfoList));pageindex++;refreshBarHeight=$("#refreshBar").offset().top;isLoadData=false;addTokenLinks();};ls.loadScript("http://wq.jd.com/jdmrefund/getafsservicelistpage?dtype=json&callback=getServiceList&orderid="+orderid+"&pagesize="+pagesize+"&pageindex="+(pageindex+1)+tempOldpin+"&t="+Math.random());isLoadData=true;}
function getStepName(){}}
function initChooseReceiptStatus(){var orderid=url.getUrlParam("orderid"),dpType=url.getUrlParam("dpType"),ispay=url.getUrlParam("ispay");if(!orderid){alert("页面参数有误！");return;}
if(dpType==1){$("#chooseStatus a[ind='1']").addClass("on");$("#barTit").text("申请取消订单");document.title='申请取消订单';}else{$("#chooseStatus a[ind='0']").addClass("on");}
$("#chooseStatus a").on("tap",function(e){e.preventDefault();var ind=$(this).attr("ind");if(dpType==1){if(ind==0){$("#barTit").text("申请维修/退换货");document.title='申请维修/退换货';}else{$("#barTit").text("申请取消订单");document.title='申请取消订单';}}
$(this).addClass("on").siblings().removeClass("on");});function changeHref(){var index=$("#chooseStatus .on").index();location.href=ls.addToken("http://wq.jd.com/jdmrefund/"+(index==0?"confirmorder?":"refundapplyentrance?ptype=1&")+"orderid="+orderid+tempOldpin+"&t="+Math.random(),'lk');}
$(".mod_btn_large").on("click",function(e){e.preventDefault();var selectType=$("#chooseStatus .on").attr("ind");if(selectType==0){ui.confirm({msg:"若选择已收到商品，您的订单状态将变为已签收，且后续返修/退换货流程必须提供商品，请务必确认您已收到商品。",icon:"info",okText:"确认",cancelText:"取消",onConfirm:changeHref,onCancel:null});}else{if(ispay==1){location.href=ls.addToken("http://wqs.jd.com/refund/dealcancle.shtml?deal_id="+orderid+tempOldpin,"lk");}else{changeHref();}}});}
function initChooseRefundItem(){var orderid=url.getUrlParam("orderid");if(!orderid){alert("页面参数有误！");return;}
$("#itemList").on("tap",".goods_item",function(){$(this).addClass("goods_item_checked").siblings().removeClass("goods_item_checked");});$("#applyRefund").on("click",function(e){e.preventDefault();var wareid=$("#itemList .goods_item_checked").attr("productid");if(!wareid){alert("请选择退款商品！");return;};location.href=ls.addToken("http://wq.jd.com/jdmrefund/getwareapplytypes?orderid="+orderid+"&wareid="+wareid+tempOldpin+"&t="+Math.random(),'lk');});}
function initApplyOrderRefund(){var orderid=url.getUrlParam("orderid"),totalNum=0,totalMoney=0;if(!orderid){alert("页面参数有误！");$("#refundOrder").hide();return;}
if(pageData&&pageData.sendPay&&pageData.sendPay.length>10&&pageData.sendPay.charAt(9)=='4'){$('#chouTopTip').show();}
if(pageData&&pageData.sendPay&&pageData.sendPay.length>44&&pageData.sendPay.charAt(43)=='1'){$('.btn_wrap').html('该订单为预售订单，请在收到商品后再发起退款流程。如有不便，敬请谅解。');}else{$("#refundOrder").attr("href",ls.addToken("http://wq.jd.com/jdmrefund/cancelorder?orderid="+orderid+tempOldpin+"&t="+Math.random(),'lk'));}
$(".goods_item").each(function(){var $me=$(this),num=$me.attr("num")*1,price=$me.attr("price")*1;totalNum+=num;totalMoney+=price*num;});$("#totalNum").html(totalNum);$("#totalMoney").html("&yen;"+totalMoney.toFixed(2));}
function initOrderRefundDetail(){if(pageData&&pageData.sendPay&&pageData.sendPay.length>10&&pageData.sendPay.charAt(9)=='4'){$('#chouTopTip').show();}
$(".state").html(getStatusName());if(pageData.refundStatus==1&&!pageData.flag){var orderid=url.getUrlParam("orderid");if(!orderid){alert("参数有误！");}
$("#btnReapply a").attr("href",ls.addToken("http://wq.jd.com/jdmrefund/refundapplyentrance?orderid="+orderid+tempOldpin+"&t="+Math.random(),'lk'));$("#btnReapply").show();}
$('.wuliu_list p[ms]').each(function(i,item){var tar=$(item),ms=tar.attr('ms');if(ms){var time=new Date(1.0*ms),y=time.getFullYear(),m=addZero(time.getMonth()+1),d=addZero(time.getDate()),h=addZero(time.getHours()),m1=addZero(time.getMinutes()),s=addZero(time.getSeconds());tar.text(y+'-'+m+'-'+d+' '+h+':'+m1+':'+s);}});function addZero(v,size){for(var i=0,len=size-(v+"").length;i<len;i++){v="0"+v;};return v+"";}
function getStatusName(){if(pageData.refundStatus==1&&!pageData.flag){return"审核不通过";}else{return["","已提交申请，待审核","待取消订单","退款处理中","完成"][pageData.refundStatus];}}
if(pageData.ddwPaySureDate!=0){$("#jindu").html("退款进度：");document.title="退款详情";}}
function initChooseApplyType(){var orderid=url.getUrlParam("orderid"),wareid=url.getUrlParam("wareid");if(!orderid||!wareid){alert("页面参数有误");return;}
if($("#applyType a").length==0){$("#applyType").html("该商品没有可以选择是售后服务！");return;}
$("#applyType a").on("click",function(){var code=$(this).attr("code");location.href=ls.addToken("http://wq.jd.com/jdmrefund/showafsselfentrance?orderid="+orderid+"&skuid="+wareid+"&cetype="+code+tempOldpin+"&t="+Math.random(),'lk');});}
function bindGoback(){$("#goback").on("tap",function(e){history.back();e.preventDefault();});}
function addTokenLinks(){$('a[mark="lk"]').each(function(ind,item){var tar=$(item),tourl=tar.attr('href');if(!tourl)return;tar.attr('href',ls.addToken(tourl,'lk'));tar.removeAttr('mark');});}
function submitForm(url,data){var form=document.createElement("form");form.action=url;form.method="post";for(var key in data){if(data.hasOwnProperty(key)){var input=document.createElement("input");input.name=key;input.value=data[key];form.appendChild(input);}}
form.submit();}
function jdDistrict(opt){var option={"ids":[],"code":[],"clsName":"","onInit":function(selAddr){},"onChange":function(selAddr){}};var provinceMap={1:"北京市",2:"上海市",3:"天津市",4:"重庆市",5:"河北省",6:"山西省",7:"河南省",8:"辽宁省",9:"吉林省",10:"黑龙江省",11:"内蒙古",12:"江苏省",13:"山东省",14:"安徽省",15:"浙江省",16:"福建省",17:"湖北省",18:"湖南省",19:"广东省",20:"广西自治区",21:"江西省",22:"四川省",23:"海南省",24:"贵州省",25:"云南省",26:"西藏自治区",27:"陕西省",28:"甘肃省",29:"青海省",30:"宁夏省",31:"新疆自治区",32:"台湾",42:"香港",43:"澳门"};var addrData,provinceId,cityId,coutyId,townId,provinceDom,cityDom,countyDom,townDom;for(var k in opt){option[k]=opt[k];}
provinceDom=document.getElementById(option.ids[0]),cityDom=document.getElementById(option.ids[1]),countyDom=document.getElementById(option.ids[2]),townDom=document.getElementById(option.ids[3]);setOptions(option.ids[0],'--选择省份--',provinceMap);if(option.code[0]){provinceId=option.code[0];setDefaultOption(option.ids[0],provinceId);if(!window["district_data_"+provinceId]&&!localStorage.getItem("district_data_"+provinceId)){loadJdAddrData(provinceId,function(){addrData=window["district_data_"+provinceId]||JSON.parse(localStorage.getItem("district_data_"+provinceId));initCity();option.onInit(getSelectedValue());});}else{addrData=window["district_data_"+provinceId]||JSON.parse(localStorage.getItem("district_data_"+provinceId));initCity();}
option.onInit(getSelectedValue());}
bindChange();function setOptions(selId,defaultText,data,valueFunc){var html=[];var valueFunc=valueFunc||function(key,data){return data[key];};defaultText&&html.push('<option value="">'+defaultText+'</option>');for(var key in data){html.push('<option value="'+key+'">'+valueFunc(key,data)+'</option>');}
document.getElementById(selId).innerHTML=html.join('');}
function setDefaultOption(selId,value){var opts=document.getElementById(selId).getElementsByTagName("option");for(var i=0,j=opts.length;i<j;i++){if(opts[i].value==value){opts[i].setAttribute("selected","selected");}}}
function initCity(){setOptions(option.ids[1],provinceId<5?'--选择区--':'--选择城市--',addrData,function(key,data){if(data[key]instanceof Array){return data[key][0];}else{return data[key];}});if(option.code[1]){var city=option.code[1];setDefaultOption(option.ids[1],city);if(provinceId<5){setOptions(option.ids[2],'--选择街道--',addrData[city][1]);}else{setOptions(option.ids[2],'--选择县/区--',addrData[city][1],function(key,data){if(data[key]instanceof Array){return data[key][0];}else{return data[key];}});}
if(option.code[2]){var county=option.code[2];setDefaultOption(option.ids[2],county);if(provinceId>4){setOptions(option.ids[3],'--选择街道/乡镇--',addrData[city][1][county][1]);if(option.code[3]){setDefaultOption(option.ids[3],option.code[3]);}}}}}
function loadJdAddrData(provinceId,callback){ls.loadScript("http://static.paipaiimg.com/js/mobile/data/address/"+provinceId+".js",{isToken:false,onLoad:function(){localStorage.setItem("district_data_"+provinceId,JSON.stringify(window["district_data_"+provinceId]));callback();}});}
function bindChange(){provinceDom.addEventListener("change",function(e){if(this.selectedIndex==0||this.options[this.selectedIndex].value==provinceId){return false;}
provinceId=this.options[this.selectedIndex].value;cityDom.innerHTML="";countyDom.innerHTML="";townDom.innerHTML="";if(!window["district_data_"+provinceId]&&!localStorage.getItem("district_data_"+provinceId)){loadJdAddrData(provinceId,function(){addrData=window["district_data_"+provinceId]||JSON.parse(localStorage.getItem("district_data_"+provinceId));setOptions(option.ids[1],provinceId<5?'--选择区--':'--选择城市--',addrData,function(key,data){if(data[key]instanceof Array){return data[key][0];}else{return data[key];}});});}else{addrData=window["district_data_"+provinceId]||JSON.parse(localStorage.getItem("district_data_"+provinceId));setOptions(option.ids[1],provinceId<5?'--选择区--':'--选择城市--',addrData,function(key,data){if(data[key]instanceof Array){return data[key][0];}else{return data[key];}});}
option.onChange(getSelectedValue());},false);cityDom.addEventListener("change",function(e){if(this.selectedIndex==0){return false;}
cityId=this.options[this.selectedIndex].value;countyDom.innerHTML="";townDom.innerHTML="";if(provinceId<5){setOptions(option.ids[2],'--选择街道--',addrData[cityId][1]);}else{setOptions(option.ids[2],'--选择县/区--',addrData[cityId][1],function(key,data){if(data[key]instanceof Array){return data[key][0];}else{return data[key];}});}
option.onChange(getSelectedValue());},false);countyDom.addEventListener("change",function(e){if(this.selectedIndex==0){return false;}
cityId=cityDom.value;countyId=this.options[this.selectedIndex].value
townDom.innerHTML="";var county=addrData[cityId][1][countyId];if(county instanceof Array){townDom.setAttribute('mark','1');setOptions(option.ids[3],'--选择街道/乡镇--',addrData[cityId][1][countyId][1]);}else{setOptions(option.ids[3],'--选择街道/乡镇--',{});townDom.setAttribute('mark','0');}
option.onChange(getSelectedValue());},false);townDom.addEventListener("change",function(e){if(this.selectedIndex==0){return false;}
option.onChange(getSelectedValue());},false);}
function getSelectedValue(){var selAddr={};if(provinceDom.selectedIndex>0){selAddr.provinceId=provinceId;selAddr.provinceName=provinceDom.options[provinceDom.selectedIndex].text;}else{selAddr.provinceId="";selAddr.provinceName="";}
if(cityDom.options.length>0&&cityDom.selectedIndex>0){selAddr.cityId=cityDom.options[cityDom.selectedIndex].value;selAddr.cityName=cityDom.options[cityDom.selectedIndex].text;}else{selAddr.cityId="";selAddr.cityName="";}
if(countyDom.options.length>0&&countyDom.selectedIndex>0){selAddr.countyId=countyDom.options[countyDom.selectedIndex].value;selAddr.countyName=countyDom.options[countyDom.selectedIndex].text;}else{selAddr.countyId="";selAddr.countyName="";}
if(townDom.options.length>0&&townDom.selectedIndex>0){selAddr.townId=townDom.options[townDom.selectedIndex].value;selAddr.townName=townDom.options[townDom.selectedIndex].text;}else{selAddr.townId="";selAddr.townName="";}
return selAddr;}}
function buildParam(paramObj){var param=[];for(var i in paramObj){if(paramObj.hasOwnProperty(i)){param.push(i+"="+paramObj[i]);}}
return param.join("&");}
function isInputTypeFileSupported(){var elem=document.createElement("input");elem.type="file";if(elem.disabled)return false;try{elem.value="Test";return elem.value!="Test";}catch(e){return elem.type=="file";}}
function getIMEntry(){var link_online=$('.link_online'),IMLink;link_online.css("display","none");if(pageData.skuIdList.length==0){if(util.isWX()){IMLink='http://wq.jd.com/wqmsg/dongdong/contactjd?source=0';}else{IMLink='http://wq.jd.com/wqmsg/dongdong/contactjd?source=1&sid='+util.getCookie('sid');}
link_online.attr('href',IMLink);}else{var item=pageData.skuIdList[0],url='http://chat1.jd.com/api/checkChat?callback=checkChatStatuCb&pid='+item.skuId;ls.loadScript(url);window.checkChatStatuCb=function(o){if(o.code==1){IMLink=['http://wq.jd.com/wqmsg/dongdong/goodsquery?skuid='+item.skuId,'imgUrl='+(encodeURIComponent(item.imgUrl)),'name='+(encodeURIComponent(item.name)),'price='+item.price,'source='+(util.isWX()?0:1),'sid='+util.getCookie('sid')||''].join('&');}else{if(util.isWX()){IMLink='http://wq.jd.com/wqmsg/dongdong/contactjd?source=0';}else{IMLink='http://wq.jd.com/wqmsg/dongdong/contactjd?source=1&sid='+util.getCookie('sid');}}
link_online.attr('href',IMLink);}}}
function checkSource(){if(pageData.iscancelorder==1){cookies.set('aftersale_iscancelorder_'+pageData.orderid,new Date().getTime(),5,'/','jd.com');}}
function initBindJd(){var bindUrl='http://party.paipai.com/tws64/jd/BindpinReq',wid=cookies.get('wg_uin'),rurl=location.href;jdPinMd5=md5.getHash(wid+rurl+"widrurl@2014");rurl=encodeURIComponent(rurl);clickUrl=bindUrl+'?wid='+wid+'&rurl='+rurl+'&check='+jdPinMd5;$('#bindJdBtn').bind('click',function(){location.href=ls.addToken(clickUrl,'lk');});}
function jumpPageCheckLogin(){login.validateLogin(function(isLogin){if(isLogin){var afsserviceid=util.getQuery("afsserviceid"),PTAG=util.getQuery("PTAG")||util.getQuery("ptag");location.href=ls.addToken("http://wq.jd.com/jdmrefund/getafsservicedetailinfo?afsserviceid="+afsserviceid+"&PTAG="+PTAG,'lk');}else{login.login({});}},true);}
exports.init_apply_for_item_refund=function(){initApplyItemRefund();bindGoback();getIMEntry();};exports.init_item_refund_detail=function(){bindGoback();initItemRefundDetail();getIMEntry();};exports.init_item_sendback=function(){bindGoback();initItemSendback();};exports.init_item_refund_list=function(){bindGoback();initItemRefundList();addTokenLinks();};exports.init_choose_receipt_status=function(){bindGoback();initChooseReceiptStatus();};exports.init_choose_refund_item=function(){bindGoback();initChooseRefundItem();};exports.init_choose_apply_type=function(){bindGoback();initChooseApplyType();};exports.init_apply_for_order_refund=function(){bindGoback();initApplyOrderRefund();};exports.init_order_refund_detail=function(){bindGoback();initOrderRefundDetail();};exports.init_bind_jd=function(){bindGoback();initBindJd();};exports.init_error_page=function(){$(".btn_wrap a").attr("href",$(".btn_wrap a").attr("href")+tempOldpin);addTokenLinks();}
exports.init_success_page=function(){$(".btn_wrap a").attr("href",$(".btn_wrap a").attr("href")+tempOldpin);addTokenLinks();getIMEntry();checkSource();}
exports.init_jump_page=function(){jumpPageCheckLogin();}});
